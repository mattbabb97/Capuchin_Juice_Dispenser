---
title: "WhatsOb Monthly Data Merge"
---

# Load packages

```{r}
library(tidyverse)
library(lubridate)
```

# Make header

```{r}
header = c('Timestamp', 'IndividualA', 'Behavior', 'IndividualB', 'IndividualC','IndividualD','IndividualE')
```

# Merge data for listed folder


```{r}
dir = getwd()

df = data.frame()
files = list.files(dir, pattern = 'txt')


for (file in files) {
    # read in next file
    group = str_split(file, ' ')[[1]][1]
    temp = read.table(str_c(dir, '/', file), col.names = header, skip = 10, 
                      na.strings = '', fill = T, stringsAsFactors = F, row.names = NULL)
    
    # add column for group, date, ...
    date = parse_datetime(str_split(file, ' ')[[1]][2], '%Y%m%d')
    ampm = str_sub(str_split(file, ' ')[[1]][3], 1, -5)
    temp = mutate(temp, Group = group, Date = as.character(date), AMPM = ampm, 
                  ObID = str_c('G_', str_sub(Group, 1, 3), str_split(file, ' ')[[1]][2],
                               AMPM), 
                  TimeInSec = as.numeric(hms(str_c('00:', Timestamp))))
    
    # add to existing data frame
    df = bind_rows(df, temp)
}
```


# Reorder columns

```{r}

df <- subset(df, select = c(11, 8:10, 12, 2:7))

```

# Reshape data

```{r}
ind2 = filter(df, !is.na(IndividualC)) %>%
    select(ObID:Behavior, IndividualC) %>%
    rename(IndividualB = IndividualC)

ind3 = filter(df, !is.na(IndividualD)) %>%
    select(ObID:Behavior, IndividualD) %>%
    rename(IndividualB = IndividualD)

ind4 = filter(df, !is.na(IndividualE)) %>%
    select(ObID:Behavior, IndividualE) %>%
    rename(IndividualB = IndividualE)

df = bind_rows(df, ind2, ind3, ind4) %>% select(-IndividualC, -IndividualD, -IndividualE)
```

# Convert Timestamp to Scan Number

```{r}
df = mutate(df, Scan = TimeInSec %/% 180 + 1) %>% select(ObID:AMPM, Scan, everything())
```

# Capitalize entered data

```{r}
df = mutate_at(df, vars(IndividualA, Behavior, IndividualB), 
               funs(str_replace_all(., '^[a-z]', toupper)))
```


# Validity checks

- (Screen for:) At least 1 entry for each individual per scan
- Only behaviors, i.e., no individuals in the `Behavior` column
- Only individuals and no behaviors in the `IndividualX` columns
- Behaviors w/o other interactor:
	+ Locomote
	+ Inactive
	+ Abnormal
	+ Solo-Feed
	+ Forage
	+ Manipulate
	+ ...
- Behaviors that need an interactor:
	+ Proximity
	+ Contact
	+ Groom (can be self but still needs an interactor)
	+ Proximity-Feed
	+ Contact-Feed
	+ Aggress?
	+ Supplant
	+ ...


```{r}
df %>% 
    group_by(Group, Date, AMPM, IndividualA) %>%
    summarise(NumScans = n_distinct(Scan)) %>%
    filter(NumScans < 10)
```

```{r}
table(df$Behavior)
table(df$IndividualA)
table(df$IndividualB)
```

```{r}
monkeys = c(NA, 'Inter-G', 'Gabe', 'Liam', 'Logan', 'Isabelle', 'Ivory', 'Ira', 'Irene', 'Ingrid', 'Paddy', 'Apple', 'Albert', 'Atilla', 'Griffin', 'Lexi', 'Lily', 'Widget', 'Wren', 'Gambit', 'Nala', 'Nkima', 'Lychee', 'Bailey', 'Beeker', 'Benny', 'Bias', 'Gonzo', 'Gretel', 'Mango', 'Mason', 'Scarlett', 'Star')

behav1 = c('Locomote', 'Inactive', 'Abnormal', 'Solo-Feed', 'Forage', 'Manipulate')
behav2 = c('Proximity', 'Contact', 'Groom', 'Proximity-Feed', 'Contact-Feed', 'Play', 'Aggress', 'Supplant', 'Aggress*', 'NC-Aggress*', 'C-Aggress*', 'PC-Affil*', 'Sexual', 'Sexual*', 'Submissive*', 'Supplant*', 'Solicit*', 'Beg*', 'Beg', 'Food-Share*')
# cofeed, active-share, passive-share?
```

```{r}
unique(df$Behavior) %>% sort %>% matrix(ncol = 2)
```

```{r}
unique(c(df$IndividualA, df$IndividualB)) %>% sort %>% matrix(ncol = 2)
```

```{r}
filter(df, Behavior %in% c(monkeys[-1], 'Manipul8') | is.na(IndividualA) | !(IndividualA %in% monkeys) | !(IndividualB %in% monkeys) | 
           (Behavior %in% behav1 & !is.na(IndividualB)) | (Behavior %in% behav2 & is.na(IndividualB)) | (IndividualA == 'Inter-G')) %>%
    select(-(Group:AMPM)) %>%
    arrange(ObID, TimeInSec)
```

```{r}
df = df %>% mutate(TimeInSec = as.integer(TimeInSec))
```


# Export combined data file

```{r}
adlib = filter(df, str_detect(Behavior, '\\*')) %>% mutate(Behavior = gsub('\\*', '', Behavior))
global = filter(df, is.na(Behavior) | !str_detect(Behavior, '\\*'))
```

```{r}
write_csv(global, str_c('WhatsOb_Global_Data_', '.csv'), na = '')
write_csv(adlib, str_c('WhatsOb_AdLib_Data_', '.csv'), na = '')
```

